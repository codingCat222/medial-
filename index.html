import React, { useState, useEffect, useCallback } from 'react';
import { initializeApp } from 'firebase/app';
import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from 'firebase/auth';
import { getFirestore, doc, onSnapshot, collection, query, setDoc, getDocs, updateDoc, arrayUnion, writeBatch } from 'firebase/firestore';
import { setLogLevel } from 'firebase/firestore';
import { BookOpen, BrainCircuit, GraduationCap, ArrowLeft, CheckCircle } from 'lucide-react';

// --- Configuration Retrieval Safety Check ---
// The original global variables (__app_id, __firebase_config, etc.) are only defined
// in the Canvas environment. When deploying to Vercel, they are undefined,
// causing the build to fail. We provide safer defaults and expect the user
// to set their own Vercel environment variables if deploying externally.

const SAFELY_GET_GLOBAL = (name, defaultValue) => {
    // Check if running in a client-side environment where globals might exist
    if (typeof window !== 'undefined' && typeof window[name] !== 'undefined') {
        return window[name];
    }
    // For Vercel/Node environment, return a safe default
    return defaultValue;
};

const appId = SAFELY_GET_GLOBAL('__app_id', 'vercel-medical-app');
// Get config as a string and parse it, or use an empty object if unavailable
const firebaseConfigString = SAFELY_GET_GLOBAL('__firebase_config', '{}');
const firebaseConfig = JSON.parse(firebaseConfigString);
const initialAuthToken = SAFELY_GET_GLOBAL('__initial_auth_token', null);

// Helper to create the public path for courses
const getCourseCollectionPath = (appId) => `/artifacts/${appId}/public/data/medicalCourses`;
// Helper to create the private path for user progress
const getUserProgressDocPath = (appId, userId) => `/artifacts/${appId}/users/${userId}/progress/user_data`;

// --- Mock Data Structure for Seeding ---
const initialMedicalCourses = [
  { id: 'mca201', code: 'MCA 201', title: 'Human Anatomy I', level: 200, topics: [
    { id: 't1', title: 'Skeletal System Overview', description: 'Study of bone structure and classification.' },
    { id: 't2', title: 'Muscular System Structure', description: 'Detailed look at muscle fiber types and attachments.' },
    { id: 't3', title: 'Nervous System Basics', description: 'Introduction to neurons, glial cells, and spinal cord segments.' },
  ]},
  { id: 'mcg202', code: 'MCG 202', title: 'Physiology Fundamentals', level: 200, topics: [
    { id: 't4', title: 'Cellular Respiration', description: 'Glycolysis, Krebs cycle, and ATP production.' },
    { id: 't5', title: 'Blood Composition', description: 'Erythrocytes, leukocytes, and plasma proteins.' },
    { id: 't6', title: 'Hormonal Regulation', description: 'Endocrine system feedback loops and common hormones.' },
  ]},
  { id: 'mcp301', code: 'MCP 301', title: 'Pharmacology I', level: 300, topics: [
    { id: 't7', title: 'Drug Absorption Kinetics', description: 'First-pass effect and routes of administration.' },
    { id: 't8', title: 'Receptor Binding', description: 'Agonists, antagonists, and competitive inhibition.' },
    { id: 't9', title: 'Antibiotic Mechanisms', description: 'Classes of antibiotics and their targets.' },
  ]},
  { id: 'mcc302', code: 'MCC 302', title: 'Clinical Chemistry', level: 300, topics: [
    { id: 't10', title: 'Enzyme Assays', description: 'Measurement principles and clinical significance.' },
    { id: 't11', title: 'Electrolyte Balance', description: 'Sodium, potassium, and fluid homeostasis.' },
    { id: 't12', title: 'Acid-Base Homeostasis', description: 'Buffers, compensation mechanisms, and common imbalances.' },
  ]},
];


// --- Main Application Component ---
const App = () => {
  // --- Firebase/Auth State ---
  const [db, setDb] = useState(null);
  const [auth, setAuth] = useState(null);
  const [userId, setUserId] = useState(null);
  const [isAuthReady, setIsAuthReady] = useState(false);
  const [error, setError] = useState(null);
  const [loading, setLoading] = useState(true);

  // --- Application State ---
  const [currentPage, setCurrentPage] = useState('dashboard');
  const [courses, setCourses] = useState([]);
  const [userProgress, setUserProgress] = useState({ readCourses: [], quizzes: [] });
  const [selectedCourse, setSelectedCourse] = useState(null);

  // 1. Firebase Initialization and Silent Authentication
  useEffect(() => {
    // Check if configuration is even remotely viable before attempting Firebase init
    const isConfigValid = firebaseConfig && firebaseConfig.apiKey && firebaseConfig.projectId;

    try {
      if (!isConfigValid) {
        console.warn("Firebase configuration is missing or invalid. Running in mock mode.");
        // Set mock state to allow UI to render without database functionality
        setUserId('mock-user-123');
        setIsAuthReady(true);
        setLoading(false);
        setError("Firebase connection failed: Configuration missing. Please set Vercel Environment Variables.");
        return;
      }

      setLogLevel('debug');
      const firebaseApp = initializeApp(firebaseConfig);
      const firestoreDb = getFirestore(firebaseApp);
      const firebaseAuth = getAuth(firebaseApp);

      setDb(firestoreDb);
      setAuth(firebaseAuth);

      const unsubscribe = onAuthStateChanged(firebaseAuth, async (user) => {
        if (user) {
          setUserId(user.uid);
        } else {
          setUserId(null);
        }
        setIsAuthReady(true);
        setLoading(false);
      });

      // Initial silent sign-in attempt
      const signInUserSilently = async () => {
        try {
          // Only attempt signInWithCustomToken if token exists
          if (initialAuthToken) {
            await signInWithCustomToken(firebaseAuth, initialAuthToken);
          } else {
            // Sign in anonymously if no token is provided (standard Vercel behavior)
            await signInAnonymously(firebaseAuth);
          }
        } catch (e) {
          console.error("Firebase Auth Error:", e);
          setError("Failed to sign in. Check console for details.");
          setIsAuthReady(true);
          setLoading(false);
        }
      };

      signInUserSilently();
      return () => unsubscribe();

    } catch (e) {
      console.error("Firebase Init Error:", e);
      setError("Failed to initialize Firebase. (Check API Key/Config)");
      setLoading(false);
    }
  }, []); // firebaseConfig is stable (from global scope)

  // 2. Data Seeding (Run once after auth is ready and DB is available)
  const seedCourses = useCallback(async () => {
    if (!db || !isAuthReady) return;

    const courseCollectionRef = collection(db, getCourseCollectionPath(appId));
    
    try {
      const existingDocs = await getDocs(query(courseCollectionRef));
      if (existingDocs.empty) {
        console.log("Seeding initial medical courses...");
        const batch = writeBatch(db);
        initialMedicalCourses.forEach(course => {
          const courseDocRef = doc(courseCollectionRef, course.id);
          batch.set(courseDocRef, course);
        });
        await batch.commit();
        console.log("Seeding complete.");
      }
    } catch (e) {
      console.error("Error checking or seeding courses:", e);
      // Don't override primary connection error if it exists
      if (!error) setError("Failed to seed initial course data.");
    }
  }, [db, isAuthReady, appId, error]);

  useEffect(() => {
    seedCourses();
  }, [seedCourses]);


  // 3. Data Fetching (Courses and User Progress)
  useEffect(() => {
    if (!db || !isAuthReady || !userId) return;

    // Fetch Courses (Public Data)
    const courseCollectionRef = collection(db, getCourseCollectionPath(appId));
    const unsubscribeCourses = onSnapshot(courseCollectionRef, (snapshot) => {
      const loadedCourses = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
      setCourses(loadedCourses);
    }, (e) => {
      console.error("Error fetching courses:", e);
      // Don't override primary connection error if it exists
      if (!error) setError("Failed to load courses.");
    });

    // Fetch User Progress (Private Data)
    const progressDocRef = doc(db, getUserProgressDocPath(appId, userId));
    const unsubscribeProgress = onSnapshot(progressDocRef, (docSnapshot) => {
      if (docSnapshot.exists()) {
        const data = docSnapshot.data();
        setUserProgress({
          readCourses: data.readCourses || [],
          quizzes: data.quizzes || [],
        });
      } else {
        // Initialize progress document if it doesn't exist
        setDoc(progressDocRef, { userId, readCourses: [], quizzes: [] }, { merge: true }).catch(e => console.error("Error initializing progress:", e));
        setUserProgress({ readCourses: [], quizzes: [] });
      }
    }, (e) => {
      console.error("Error fetching user progress:", e);
      if (!error) setError("Failed to load user progress.");
    });

    return () => {
      unsubscribeCourses();
      unsubscribeProgress();
    };
  }, [db, isAuthReady, userId, appId, error]);


  // --- Event Handlers ---

  const handleCourseSelect = (course) => {
    setSelectedCourse(course);
    setCurrentPage('topics');
  };

  const handleTopicRead = async (courseId, courseCode, topicTitle) => {
    if (!db || !userId) {
      setError("Cannot save progress: Not connected to the database.");
      return;
    }

    const progressDocRef = doc(db, getUserProgressDocPath(appId, userId));
    const readKey = `${courseId}-${topicTitle}`;
    const quizKey = `${courseCode}-${topicTitle}`;

    try {
      // 1. Mark topic as read (using arrayUnion to prevent duplicates)
      await updateDoc(progressDocRef, {
        readCourses: arrayUnion(readKey)
      });
      console.log(`Topic ${topicTitle} marked as read.`);

      // 2. Mock Quiz Attempt (Only if it's not already logged as attempted)
      const existingQuiz = userProgress.quizzes.find(q => q.key === quizKey);
      if (!existingQuiz) {
        await updateDoc(progressDocRef, {
          quizzes: arrayUnion({ 
            key: quizKey, 
            courseCode: courseCode, 
            topic: topicTitle, 
            score: Math.floor(Math.random() * 5) + 6, // Mock score 6-10
            maxScore: 10, 
            date: new Date().toISOString() 
          })
        });
        console.log(`Mock quiz recorded for ${topicTitle}.`);
      }
    } catch (e) {
      console.error("Error updating progress:", e);
      setError("Failed to update user progress.");
    }
  };

  // --- Utility Components (same as before) ---
  const LoadingSpinner = () => (
    <div className="flex flex-col items-center justify-center min-h-screen bg-gray-50">
      <div className="animate-spin rounded-full h-16 w-16 border-t-4 border-b-4 border-blue-500"></div>
      <p className="mt-4 text-gray-600 font-medium">Authenticating and loading courses...</p>
    </div>
  );

  const Card = ({ children, title, className = '' }) => (
    <div className={`bg-white p-6 shadow-xl rounded-xl ${className}`}>
      {title && <h2 className="text-3xl font-bold text-gray-800 mb-6 border-b pb-2">{title}</h2>}
      {children}
    </div>
  );

  const Header = ({ title, showBack, onBack, children }) => (
    <div className="sticky top-0 bg-white shadow-md p-4 mb-6 z-10">
      <div className="max-w-6xl mx-auto flex justify-between items-center">
        <div className="flex items-center">
          {showBack && (
            <button onClick={onBack} className="mr-3 p-2 rounded-full text-gray-600 hover:bg-gray-200 transition duration-150">
              <ArrowLeft className="h-6 w-6" />
            </button>
          )}
          <h1 className="text-3xl font-extrabold text-gray-900 flex items-center space-x-2">
            <GraduationCap className="w-8 h-8 text-blue-600" />
            <span>{title}</span>
          </h1>
        </div>
        <div className="flex items-center space-x-3">
          {children}
          <div className="text-sm text-gray-500 hidden sm:block">
            <span className="font-semibold">User ID:</span> 
            <span className="font-mono text-xs ml-1 bg-gray-100 p-1 rounded">{userId || 'N/A'}</span>
          </div>
        </div>
      </div>
    </div>
  );
  
  // DashboardView, CourseListView, CourseCard, TopicsView are unchanged from the previous, working version (omitted for brevity)
  
  const DashboardView = () => {
    const attemptedQuizzes = userProgress.quizzes.length;
    const uniqueReadCourses = new Set(userProgress.readCourses.map(key => key.split('-')[0])).size;

    return (
      <div className="p-4 sm:p-6 bg-gray-50 min-h-screen">
        <Header title="Dashboard" showBack={false}>
          <button
            onClick={() => setCurrentPage('courses')}
            className="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-lg transition duration-150 shadow-md flex items-center space-x-2"
          >
            <BookOpen className="w-5 h-5" />
            <span>Browse Courses</span>
          </button>
        </Header>

        <div className="max-w-6xl mx-auto">
          <div className="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
            <Card title="Progress Summary" className="bg-gradient-to-r from-blue-50 to-blue-100">
              <div className="flex justify-around items-center text-gray-800">
                <div className="text-center p-3">
                  <p className="text-6xl font-extrabold text-blue-600">{uniqueReadCourses}</p>
                  <p className="text-lg font-medium mt-1">Courses Started</p>
                </div>
                <div className="text-center p-3">
                  <p className="text-6xl font-extrabold text-indigo-600">{attemptedQuizzes}</p>
                  <p className="text-lg font-medium mt-1">Quizzes Attempted</p>
                </div>
              </div>
            </Card>

            <Card title="Recent Quiz Attempts" className="h-full">
              {userProgress.quizzes.slice(-5).reverse().length > 0 ? (
                <ul className="space-y-3">
                  {userProgress.quizzes.slice(-5).reverse().map((quiz, index) => (
                    <li key={index} className="flex flex-col sm:flex-row justify-between items-start sm:items-center p-3 bg-gray-50 rounded-lg border-l-4 border-indigo-400">
                      <div className="text-sm font-medium text-gray-700">
                        <span className="font-bold mr-1">{quiz.courseCode}:</span> {quiz.topic}
                      </div>
                      <span className={`text-xs font-bold px-2 py-1 rounded-full mt-1 sm:mt-0 ${quiz.score >= 7 ? 'bg-green-100 text-green-700' : 'bg-yellow-100 text-yellow-700'}`}>
                        Score: {quiz.score}/{quiz.maxScore}
                      </span>
                    </li>
                  ))}
                </ul>
              ) : (
                <p className="text-gray-500 italic">No activity recorded. Start a course to track your progress!</p>
              )}
            </Card>
          </div>
          
          <CourseListView compact={true} />
        </div>
      </div>
    );
  };

  const CourseListView = ({ compact = false }) => {
    const courses200L = courses.filter(c => c.level === 200).sort((a, b) => a.code.localeCompare(b.code));
    const courses300L = courses.filter(c => c.level === 300).sort((a, b) => a.code.localeCompare(b.code));

    const courseListContent = (
      <>
        <h3 className="text-2xl font-semibold text-gray-700 mb-4 border-b border-gray-200 pb-2">200 Level Courses</h3>
        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 mb-8">
          {courses200L.map(course => (
            <CourseCard key={course.id} course={course} onSelect={handleCourseSelect} userProgress={userProgress} />
          ))}
        </div>

        <h3 className="text-2xl font-semibold text-gray-700 mb-4 border-b border-gray-200 pb-2">300 Level Courses</h3>
        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
          {courses300L.map(course => (
            <CourseCard key={course.id} course={course} onSelect={handleCourseSelect} userProgress={userProgress} />
          ))}
        </div>
      </>
    );

    if (compact) {
      return (
        <Card title="All Medical Courses" className="mt-6">
          {courseListContent}
        </Card>
      );
    }

    // Full Course List View
    return (
      <div className="p-4 sm:p-6 bg-gray-50 min-h-screen">
        <Header title="All Medical Courses" showBack={true} onBack={() => setCurrentPage('dashboard')} />
        <div className="max-w-6xl mx-auto">
          <Card title="Course Catalog">
            {courseListContent}
          </Card>
        </div>
      </div>
    );
  };

  const CourseCard = ({ course, onSelect, userProgress }) => {
    const totalTopics = course.topics.length;
    const readCount = course.topics.filter(topic =>
      userProgress.readCourses.includes(`${course.id}-${topic.title}`)
    ).length;
    const progress = totalTopics > 0 ? Math.round((readCount / totalTopics) * 100) : 0;

    return (
      <div
        className="bg-white border border-gray-200 p-5 rounded-xl shadow-lg hover:shadow-xl transition duration-300 cursor-pointer flex flex-col justify-between"
        onClick={() => onSelect(course)}
      >
        <div>
          <span className="text-sm font-bold text-blue-600 bg-blue-100 px-3 py-1 rounded-full">{course.code}</span>
          <h4 className="text-xl font-bold mt-2 text-gray-800 line-clamp-2">{course.title}</h4>
        </div>
        <div className="mt-4">
          <div className="flex justify-between text-sm text-gray-600 mb-1">
            <span>Progress</span>
            <span className="font-semibold text-blue-600">{progress}%</span>
          </div>
          <div className="w-full bg-gray-200 rounded-full h-2.5">
            <div
              className="bg-blue-600 h-2.5 rounded-full transition-all duration-500"
              style={{ width: `${progress}%` }}
            ></div>
          </div>
          <p className="text-xs text-gray-500 mt-1">{readCount} of {totalTopics} topics read</p>
        </div>
      </div>
    );
  };

  const TopicsView = () => {
    if (!selectedCourse) return <p className="p-6">Course not selected.</p>;

    return (
      <div className="p-4 sm:p-6 bg-gray-50 min-h-screen">
        <Header 
          title={`${selectedCourse.code}: ${selectedCourse.title}`} 
          showBack={true} 
          onBack={() => setCurrentPage('courses')} 
        />

        <Card title="Core Topics" className="max-w-4xl mx-auto mt-6">
          <p className="text-gray-600 mb-6 italic">
            Click on a topic to mark it as read. This also simulates a **quiz attempt** for your dashboard.
          </p>
          <ul className="space-y-4">
            {selectedCourse.topics.map((topic, index) => {
              const isRead = userProgress.readCourses.includes(`${selectedCourse.id}-${topic.title}`);
              const hasAttemptedQuiz = userProgress.quizzes.some(q => q.key === `${selectedCourse.code}-${topic.title}`);

              return (
                <li
                  key={index}
                  className={`p-4 rounded-xl border-l-8 cursor-pointer transition duration-200 shadow-md ${
                    isRead ? 'bg-green-50 border-green-500 hover:bg-green-100' : 'bg-white border-blue-400 hover:bg-blue-50'
                  }`}
                  onClick={() => handleTopicRead(selectedCourse.id, selectedCourse.code, topic.title)}
                >
                  <div className="flex justify-between items-center">
                    <h5 className="text-lg font-bold text-gray-800 flex items-center space-x-2">
                      <BookOpen className="w-5 h-5 text-gray-600" />
                      <span>{topic.title}</span>
                    </h5>
                    <div className="flex items-center space-x-3 text-sm font-medium">
                      {hasAttemptedQuiz && (
                        <span className="bg-indigo-100 text-indigo-700 px-3 py-1 rounded-full flex items-center">
                          <BrainCircuit className="w-4 h-4 mr-1" />
                          Quiz Done
                        </span>
                      )}
                      {isRead ? (
                        <span className="text-green-700 flex items-center">
                          <CheckCircle className="h-5 w-5 mr-1" />
                          Read
                        </span>
                      ) : (
                        <span className="text-gray-500">Mark as Read</span>
                      )}
                    </div>
                  </div>
                  <p className="text-sm text-gray-600 mt-2">{topic.description}</p>
                </li>
              );
            })}
          </ul>
        </Card>
      </div>
    );
  };


  // --- Main Render Logic ---
  if (loading || !isAuthReady) {
    return <LoadingSpinner />;
  }

  // Display a prominent error if Firebase configuration is missing (Vercel deployment)
  if (error && error.includes('Configuration missing')) {
    return (
      <div className="p-6 bg-red-100 text-red-700 min-h-screen">
        <h1 className="text-3xl font-bold mb-4">Deployment Error: Firebase Configuration Required</h1>
        <p className="mb-4">This application needs Firebase credentials to connect to the database and track user progress. The provided global variables were not found in the Vercel environment.</p>
        <p className="font-semibold">To fix this, you must set the following values as **Environment Variables** in your Vercel project settings:</p>
        
        <div className="mt-4 p-4 bg-red-50 rounded-lg border border-red-300 font-mono text-sm">
          <p className="mb-2"><span className="font-bold text-red-800">1. APP_ID</span>: A unique ID for your app (e.g., `e-learning-v1`). This replaces `__app_id`.</p>
          <p><span className="font-bold text-red-800">2. FIREBASE_CONFIG</span>: Your entire Firebase JSON config object as a **single, escaped string**.</p>
          <p className="mt-3 text-xs italic">Example (make sure to replace the values with your own):</p>
          <pre className="whitespace-pre-wrap p-2 bg-gray-100 rounded mt-1">
            &#123;"apiKey":"AIzaSy...","authDomain":"your-project.firebaseapp.com","projectId":"your-project-id", ... &#125;
          </pre>
        </div>
        <p className="mt-4">Since Vercel doesn't use the custom auth token, the app will sign users in anonymously, which is safe for tracking private data.</p>
      </div>
    );
  }

  // Handle other runtime errors
  if (error) {
    return (
      <div className="p-6 bg-red-100 text-red-700 min-h-screen">
        <p className="text-lg font-bold mb-4">Runtime Error</p>
        <p>{error}</p>
      </div>
    );
  }

  // Render the current page view
  switch (currentPage) {
    case 'courses':
      return <CourseListView compact={false} />;
    case 'topics':
      return <TopicsView />;
    case 'dashboard':
    default:
      return <DashboardView />;
  }
};

export default App;
